const axios = require('axios');

/**
 * æ ¹æ®è®¾è®¡æ–‡æ¡£ï¼Œæ„å»ºå‘é€ç»™å¤§è¯­è¨€æ¨¡å‹çš„å®Œæ•´æŒ‡ä»¤ (Prompt)
 * @param {string} reviewText - ç”¨æˆ·è¾“å…¥çš„å·®è¯„åŸæ–‡
 * @param {string} language - ç”¨æˆ·é€‰æ‹©çš„è¯­è¨€ ('mandarin' æˆ– 'cantonese')
 * @returns {Array} - ç¬¦åˆå¤§æ¨¡å‹APIè¦æ±‚çš„ messages æ•°ç»„
 */
const buildPrompt = (reviewText, language) => {
  const langMap = {
    mandarin: 'æ™®é€šè¯',
    cantonese: 'ç²¤è¯­'
  };

  // æ¥è‡ªæˆ‘ä»¬è®¾è®¡æ–‡æ¡£ v3.1 çš„æ ¸å¿ƒæŒ‡ä»¤ï¼ˆå·²ä¼˜åŒ–ï¼‰
  const promptContent = `
**è§’è‰²**: ä½ æ˜¯ä¸€ä¸ªé¡¶çº§çš„é¤å…å®¢æœä¸“å®¶ï¼Œæ‹¥æœ‰å¤šå¹´çš„å®¢æˆ·å…³ç³»å¤„ç†ç»éªŒï¼Œå°¤å…¶æ“…é•¿å¤„ç†å¤–å–å·®è¯„ã€‚ä½ çš„ç›®æ ‡æ˜¯é€šè¿‡ä¸“ä¸šã€æœ‰åŒç†å¿ƒä¸”é«˜æ•ˆçš„æ²Ÿé€šï¼Œå°†è´Ÿé¢è¯„ä»·è½¬åŒ–ä¸ºæ­£é¢ä½“éªŒã€‚

**æ ¸å¿ƒä»»åŠ¡**:
1.  **æ·±åº¦åˆ†æå·®è¯„**: å¯¹ä»¥ä¸‹ç”¨æˆ·å·®è¯„è¿›è¡Œå¤šç»´åº¦åˆ†æã€‚
2.  **ç”Ÿæˆé«˜è´¨é‡ã€æ— æˆæœ¬æ‰¿è¯ºçš„å›å¤**: æ ¹æ®åˆ†æç»“æœï¼Œç»“åˆå¤šç§ã€è§’åº¦ã€‘å’Œã€é£æ ¼ã€‘ï¼Œä¸ºæŒ‡å®šçš„ **${langMap[language] || 'ç²¤è¯­'}** ç”Ÿæˆ9ç§å›å¤ã€‚
3.  **ä¸¥æ ¼çš„å®‰å…¨é™åˆ¶**: **ç»å¯¹ç¦æ­¢** åœ¨å›å¤ä¸­æåŠä»»ä½•å½¢å¼çš„å…·ä½“è¡¥å¿æªæ–½ï¼Œä¾‹å¦‚"é€€æ¬¾"ã€"é‡åš"ã€"è¡¥é€"ã€"ä¼˜æƒ åˆ¸"ã€"ä»£é‡‘åˆ¸"ã€"æŠ˜æ‰£"ç­‰è¯è¯­ã€‚å›å¤åº”èšç„¦äºå®‰æŠšæƒ…ç»ªã€è§£é‡Šé—®é¢˜å’Œè¡¨è¾¾æ­‰æ„ã€‚
4.  **æ ¼å¼åŒ–è¾“å‡º**: ä½ çš„æœ€ç»ˆå›ç­”å¿…é¡»æ˜¯ä¸€ä¸ªå®Œæ•´çš„ã€å¯ä»¥è¢«ç¨‹åºç›´æ¥è§£æçš„JSONå¯¹è±¡ï¼Œä¸¥æ ¼éµå¾ªä»¥ä¸‹ç»“æ„ï¼Œä¸è¦æœ‰ä»»ä½•å¤šä½™çš„æ–‡å­—ã€è§£é‡Šæˆ–ä»£ç å—æ ‡è®°ã€‚

**å›å¤è´¨é‡å‡†åˆ™ (å¿…é¡»ä¸¥æ ¼éµå®ˆ)**:
*   **é¿å…ç©ºè¯å¥—è¯**: ä¸è¦ä½¿ç”¨"æˆ‘ä»¬æ·±æ„ŸæŠ±æ­‰"ã€"ç»™æ‚¨å¸¦æ¥ä¸ä¾¿æ•¬è¯·è°…è§£"ç­‰æ¨¡æ¿å¼è¯­å¥ã€‚
*   **å…±æƒ…ä¸å®‰æŠš**: çœŸè¯šåœ°ç«™åœ¨ç”¨æˆ·çš„è§’åº¦ç†è§£ä»–çš„æ„Ÿå—ã€‚
*   **ä¸»åŠ¨æ‰¿æ‹…è´£ä»»**: ä¸è¦æ¨å¸è´£ä»»ï¼Œç›´æ¥æ‰¿è®¤é—®é¢˜æ‰€åœ¨ã€‚
*   **æ‰¿è¯ºè·Ÿè¿›ï¼Œè€Œéæˆæœ¬è¡¥å¿**: å¯ä»¥æ‰¿è¯ºè¿›è¡Œå†…éƒ¨è°ƒæŸ¥ã€æˆ–ç”±ä¸“äººè”ç³»å®¢æˆ·ï¼Œä½†ä¸èƒ½ç›´æ¥æå‡ºä»»ä½•éœ€è¦æˆæœ¬çš„è¡¥å¿æ–¹æ¡ˆã€‚
*   **ä½“ç°å“ç‰Œä¸ªæ€§**: åœ¨ä¸åŒé£æ ¼çš„å›å¤ä¸­ï¼Œæ³¨å…¥å¯¹åº”çš„å“ç‰Œäººè®¾ã€‚

**é£æ ¼è¯´æ˜**:
*   **è¯šæ³é£æ ¼**: è¯­æ°”çœŸè¯šã€ä¸“ä¸šï¼Œè¡¨è¾¾è´£ä»»æ„Ÿ
*   **å–èŒé£æ ¼**: é€‚å½“ä½¿ç”¨emojiè¡¨æƒ…ç¬¦å·ï¼ˆå¦‚ğŸ˜…ğŸ¥°ğŸ˜Šç­‰ï¼‰ï¼Œè¯­æ°”å¯çˆ±äº²åˆ‡ï¼Œä½†ä»ä¿æŒä¸“ä¸š
*   **éœ¸æ°”é£æ ¼**: è¯­æ°”è‡ªä¿¡ã€æœ‰æ‹…å½“ï¼Œä½“ç°å“ç‰Œå®åŠ›

**ç”¨æˆ·å·®è¯„**:
\`\`\`
${reviewText}
\`\`\`

**è¾“å‡ºJSONç»“æ„**:
\`\`\`json
{
  "analysis": {
    "issueType": "åˆ†æå‡ºçš„é—®é¢˜ç±»å‹ (ä¾‹å¦‚: é…é€é—®é¢˜, èœå“è´¨é‡, æœåŠ¡æ€åº¦)",
    "anger": "ä¸€ä¸ªä»£è¡¨ç”¨æˆ·æ„¤æ€’ç¨‹åº¦çš„æ•´æ•° (0-100)",
    "keywords": "æå–å‡ºçš„æ ¸å¿ƒçŸ›ç›¾å…³é”®è¯ (å­—ç¬¦ä¸²)"
  },
  "replies": {
    "è¯šæ³é“æ­‰": {
      "sincere": "åŸºäº'è¯šæ³é“æ­‰'è§’åº¦çš„è¯šæ³å›å¤",
      "cute": "åŸºäº'è¯šæ³é“æ­‰'è§’åº¦çš„å–èŒå›å¤ï¼ˆå«emojiï¼‰",
      "confident": "åŸºäº'è¯šæ³é“æ­‰'è§’åº¦çš„éœ¸æ°”å›å¤"
    },
    "é—®é¢˜è§£é‡Š": {
      "sincere": "åŸºäº'é—®é¢˜è§£é‡Š'è§’åº¦çš„è¯šæ³å›å¤", 
      "cute": "åŸºäº'é—®é¢˜è§£é‡Š'è§’åº¦çš„å–èŒå›å¤ï¼ˆå«emojiï¼‰",
      "confident": "åŸºäº'é—®é¢˜è§£é‡Š'è§’åº¦çš„éœ¸æ°”å›å¤"
    },
    "å®‰æŠšç”¨æˆ·": {
      "sincere": "åŸºäº'å®‰æŠšç”¨æˆ·'è§’åº¦çš„è¯šæ³å›å¤",
      "cute": "åŸºäº'å®‰æŠšç”¨æˆ·'è§’åº¦çš„å–èŒå›å¤ï¼ˆå«emojiï¼‰", 
      "confident": "åŸºäº'å®‰æŠšç”¨æˆ·'è§’åº¦çš„éœ¸æ°”å›å¤"
    }
  }
}
\`\`\`
`;

  return [
    {
      role: "system",
      content: "You are a helpful assistant."
    },
    {
      role: "user",
      content: promptContent.trim()
    }
  ];
};

/**
 * æ¸…ç†å¹¶è§£ææ¥è‡ªå¤§æ¨¡å‹çš„å›å¤
 * @param {string} rawContent - å¤§æ¨¡å‹è¿”å›çš„åŸå§‹å­—ç¬¦ä¸²
 * @returns {object} - è§£æåçš„JSONå¯¹è±¡
 */
const parseLLMResponse = (rawContent) => {
  // å»é™¤å¯èƒ½çš„Markdownä»£ç å—æ ‡è®°
  const cleanedContent = rawContent.replace(/^```json\s*/, '').replace(/\s*```$/, '');
  try {
    return JSON.parse(cleanedContent);
  } catch (e) {
    console.error("Failed to parse LLM response JSON:", e);
    console.error("Raw content was:", rawContent);
    throw new Error("è¿”å›æ•°æ®æ ¼å¼é”™è¯¯ï¼Œæ— æ³•è§£æä¸ºJSONã€‚");
  }
};


// äº‘å‡½æ•°å…¥å£å‡½æ•°
exports.main = async (event, context) => {
  // ä»ç¯å¢ƒå˜é‡ä¸­å®‰å…¨åœ°è·å–APIå¯†é’¥
  const apiKey = process.env.ARK_API_KEY;
  const modelId = 'doubao-1-5-pro-32k-250115';
  const url = 'https://ark.cn-beijing.volces.com/api/v3/chat/completions';

  if (!apiKey) {
    console.error("API Key not found in environment variables.");
    return {
      errCode: -1,
      errMsg: 'äº‘å‡½æ•°æœªé…ç½®APIå¯†é’¥ï¼Œè¯·åœ¨äº‘å¼€å‘æ§åˆ¶å°çš„ç¯å¢ƒå˜é‡ä¸­è®¾ç½® ARK_API_KEYã€‚'
    };
  }

  const { reviewText, language } = event;
  if (!reviewText) {
    return { errCode: -2, errMsg: 'è¯·æ±‚å‚æ•°é”™è¯¯ï¼Œç¼ºå°‘è¯„ä»·å†…å®¹(reviewText)ã€‚' };
  }

  const messages = buildPrompt(reviewText, language);

  try {
    const response = await axios.post(
      url,
      { model: modelId, messages },
      {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        timeout: 30000 // è®¾ç½®30ç§’è¶…æ—¶
      }
    );

    if (response.data && response.data.choices && response.data.choices[0]) {
      const resultData = parseLLMResponse(response.data.choices[0].message.content);
      return {
        errCode: 0,
        errMsg: 'success',
        data: resultData
      };
    } else {
      throw new Error("å¤§æ¨¡å‹è¿”å›æ•°æ®ç»“æ„ä¸ç¬¦åˆé¢„æœŸã€‚");
    }

  } catch (error) {
    console.error('è°ƒç”¨å¤§æ¨¡å‹APIå¤±è´¥:', error);

    let errMsg = 'è°ƒç”¨å¤§æ¨¡å‹æœåŠ¡å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚';
    if (error.response) { // æœåŠ¡ç«¯æœ‰è¿”å›ï¼Œä½†çŠ¶æ€ç æ˜¯å¤±è´¥çš„
      errMsg = `APIé”™è¯¯: ${error.response.status} ${JSON.stringify(error.response.data)}`;
    } else if (error.request) { // è¯·æ±‚å·²å‘å‡ºï¼Œä½†æ²¡æœ‰æ”¶åˆ°å“åº”
      errMsg = 'è¯·æ±‚è¶…æ—¶æˆ–ç½‘ç»œé”™è¯¯ï¼Œæœªèƒ½æ”¶åˆ°å¤§æ¨¡å‹æœåŠ¡å“åº”ã€‚';
    } else { // å…¶ä»–é”™è¯¯ï¼Œå¦‚è¯·æ±‚è®¾ç½®é—®é¢˜
      errMsg = `è¯·æ±‚è®¾ç½®é”™è¯¯: ${error.message}`;
    }

    return {
      errCode: -3,
      errMsg: errMsg
    };
  }
};
